OBJECT Report 50095 Adjust Local Currency CB
{
  OBJECT-PROPERTIES
  {
    Date=10.08.17;
    Time=11:53:05;
    Modified=Yes;
    Version List=NOS-26;
  }
  PROPERTIES
  {
    Permissions=TableData 86=rimd;
    CaptionML=[ENU=Revaluation Currency Operation CB;
               RUS=Переоценка Вал. Операций по курсу ЦБ];
    ProcessingOnly=Yes;
    OnInitReport=BEGIN
                   g_recConsSetup.GET;
                   g_recMovSetup.GET;
                   g_codeBusUnitCode := '';
                   IF g_recConsSetup."Consolidation Filial Code" <> '' THEN
                     g_codeBusUnitCode := g_recConsSetup."Consolidation Filial Code";
                   g_recGLSetup.GET;

                   IF CurrReport.USEREQUESTPAGE THEN
                     g_dateIndex := g_recGLSetup."Allow Posting To";
                   g_txtColumnDim := g_recDimSelectionBuf1.GetDimSelectionText(3,REPORT::"Adjust Local Currency CB",'');

                   //TDRANCS-1196 >
                   g_recCompany.GET(COMPANYNAME);
                   //TDRANCS-1196 <

                   g_recStandParam.RESET;
                   g_recStandParam.SETRANGE("Report ID",REPORT::"Adjust Local Currency CB");


                   //TDRANCS-1196>
                   CASE g_recCompany."Company Type" OF
                     g_recCompany."Company Type"::Standalone:
                       g_recStandParam.SETRANGE("Activity Type", g_recStandParam."Activity Type"::"SA Activity");
                     g_recCompany."Company Type"::Consolidation:
                       g_recStandParam.SETRANGE("Activity Type", g_recStandParam."Activity Type"::"Consolidation Activity");
                   END;
                   //TDRANCS-1196<

                   IF g_recStandParam.FINDFIRST THEN BEGIN
                     IF (g_recStandParam."Posting Date" <> '') AND CurrReport.USEREQUESTPAGE THEN
                       g_dateIndex := CALCDATE(g_recStandParam."Posting Date",WORKDATE);
                     IF g_recStandParam."Gen. Journal Template" <> '' THEN
                       g_codeTemplate := g_recStandParam."Gen. Journal Template";
                     IF g_recStandParam."Gen. Journal Batch" <> '' THEN
                       g_codeBatch := g_recStandParam."Gen. Journal Batch";
                     IF g_recStandParam."Prefix Numbers" <> '' THEN
                       g_codeDocumentNo := g_recStandParam."Prefix Numbers";
                     IF g_dateIndex <> 0D THEN
                       g_codeDocumentNo := g_codeDocumentNo + FORMAT(g_dateIndex,0,9);
                     IF g_recStandParam."Posting Description" <> '' THEN
                       g_txtPostingDescription := g_recStandParam."Posting Description";
                     g_boolPost81 := g_recStandParam.Post;
                     //NC MIO-35 > DP
                     g_blnIsByBusinessUnit := g_recStandParam."Group By Business Unit";
                     //NC MIO-35 < DP

                   END ELSE
                     ERROR(Text50002 + g_recStandParam.TABLECAPTION);

                   g_intAdjRegTmpCnt := 1;
                 END;

    OnPreReport=VAR
                  s@1101495000 : Text[1024];
                BEGIN

                  IF NOT CurrReport.USEREQUESTPAGE THEN BEGIN
                    g_recConsSetup.GET;
                    g_recMovSetup.GET;
                    g_codeBusUnitCode := '';
                    IF g_recConsSetup."Consolidation Filial Code" <> '' THEN
                      g_codeBusUnitCode := g_recConsSetup."Consolidation Filial Code";
                    g_recGLSetup.GET;

                    IF CurrReport.USEREQUESTPAGE THEN
                      g_dateIndex := g_recGLSetup."Allow Posting To";
                    g_txtColumnDim := g_recDimSelectionBuf1.GetDimSelectionText(3,REPORT::"Adjust Local Currency CB",'');

                    g_recStandParam.RESET;
                    g_recStandParam.SETRANGE("Report ID",REPORT::"Adjust Local Currency CB");

                    //TDRANCS-1196>
                    CASE g_recCompany."Company Type" OF
                      g_recCompany."Company Type"::Standalone:
                        g_recStandParam.SETRANGE("Activity Type", g_recStandParam."Activity Type"::"SA Activity");
                      g_recCompany."Company Type"::Consolidation:
                        g_recStandParam.SETRANGE("Activity Type", g_recStandParam."Activity Type"::"Consolidation Activity");
                    END;
                    //TDRANCS-1196<

                    IF g_recStandParam.FINDFIRST THEN BEGIN
                      IF (g_recStandParam."Posting Date"<>'') AND CurrReport.USEREQUESTPAGE THEN
                        g_dateIndex:=CALCDATE(g_recStandParam."Posting Date",WORKDATE);
                      IF g_recStandParam."Gen. Journal Template"<>'' THEN
                        g_codeTemplate:=g_recStandParam."Gen. Journal Template";
                      IF g_recStandParam."Gen. Journal Batch"<>'' THEN
                        g_codeBatch:=g_recStandParam."Gen. Journal Batch";
                      IF g_recStandParam."Prefix Numbers"<>'' THEN
                        g_codeDocumentNo := g_recStandParam."Prefix Numbers";
                      IF g_dateIndex <> 0D THEN
                        g_codeDocumentNo := g_codeDocumentNo + FORMAT(g_dateIndex,0,9);
                      IF g_recStandParam."Posting Description" <> '' THEN
                        g_txtPostingDescription := g_recStandParam."Posting Description";
                      g_boolPost81 := g_recStandParam.Post;
                      //NC MIO-35 > DP
                      g_blnIsByBusinessUnit := g_recStandParam."Group By Business Unit";
                      //NC MIO-35 < DP
                    END ELSE
                      ERROR(Text50002+g_recStandParam.TABLECAPTION);

                    g_intAdjRegTmpCnt := 1;
                  END;

                  //g_cuLog.WriteLogFile('Переоценка Валютных Операций',TRUE,FALSE,1);

                  fn_GetSelectedDims;
                  fn_GetNewSelectedDims;
                  g_intRet := 0;

                  IF GUIALLOWED THEN
                    g_dlgWindow.OPEN(Text019 + Text009 + Text50013 + Text011);

                  g_boolClosePerGlobalDim1 := FALSE;
                  g_boolClosePerGlobalDim2 := FALSE;
                  g_boolClosePerGlobalDimOnly := TRUE;

                  IF gt_recSelectedDim.FIND('-') THEN
                    REPEAT
                      IF gt_recSelectedDim."Dimension Code" = g_recGLSetup."Global Dimension 1 Code" THEN
                        g_boolClosePerGlobalDim1 := TRUE;
                      IF gt_recSelectedDim."Dimension Code" = g_recGLSetup."Global Dimension 2 Code" THEN
                        g_boolClosePerGlobalDim2 := TRUE;
                      IF (gt_recSelectedDim."Dimension Code" <> g_recGLSetup."Global Dimension 1 Code") AND
                         (gt_recSelectedDim."Dimension Code" <> g_recGLSetup."Global Dimension 2 Code")
                      THEN
                        g_boolClosePerGlobalDimOnly := FALSE;
                    UNTIL gt_recSelectedDim.NEXT = 0;

                  IF g_recGenJnlBatch.GET(g_codeTemplate,g_codeBatch) THEN;
                  IF g_recSourceCodeSetup.GET THEN;

                  //TDRANCS-1348>
                  g_recGenJnlLine.SETRANGE("Journal Template Name",g_codeTemplate);
                  g_recGenJnlLine.SETRANGE("Journal Batch Name",g_codeBatch);
                  g_recGenJnlLine.DELETEALL(TRUE);
                  g_recGenJnlLine.RESET;
                  //TDRANCS-1348<

                  //g_Time1 := TIME;
                END;

    OnPostReport=BEGIN
                   g_recGenJnlLine.SETRANGE("Journal Template Name",g_codeTemplate);
                   g_recGenJnlLine.SETRANGE("Journal Batch Name",g_codeBatch);
                   //g_cuLog.WriteLogFile('COUNT GLE Prececced' +
                   //  FORMAT(g_intTestCount) + ' Gen.Jnl.Line: ' + FORMAT(g_recGenJnlLine.COUNT),FALSE,FALSE,0);
                   //g_cuLog.WriteLogFile('Переоценка Валютных Операций',FALSE,TRUE,1);

                   IF GUIALLOWED THEN
                     g_dlgWindow.CLOSE;

                   g_recGenJnlLine.RESET;
                   g_recGenJnlLine.SETRANGE("Journal Template Name",g_codeTemplate);
                   g_recGenJnlLine.SETRANGE("Journal Batch Name",g_codeBatch);
                   g_recGenJnlLine.SETRANGE("Line No.",g_intLineMin,g_intLineMax);
                   IF g_recGenJnlLine.COUNT = 0 THEN BEGIN
                      MESSAGE(Text50006);
                   END ELSE BEGIN
                     IF g_boolPost81 THEN  BEGIN

                       //NC MIO-35.5 > DP
                       g_repPartPostLine.SetLineJobProcNo(g_JobProcLineNo);
                       //NC MIO-35.5 < DP

                       g_repPartPostLine.USEREQUESTPAGE(FALSE);
                       g_repPartPostLine.SETTABLEVIEW(g_recGenJnlLine);
                       g_repPartPostLine.RUNMODAL();
                       MESSAGE(Text00001);
                     END ELSE
                       MESSAGE(Text50005);
                   END;
                   //g_Time2 := TIME;
                   //MESSAGE('%1',g_Time2 - g_Time1);
                 END;

  }
  DATASET
  {
    { 1101495000;;DataItem;                  ;
               DataItemTable=Table15;
               OnPreDataItem=BEGIN
                               IF g_optGLAccountRevalType <> g_optGLAccountRevalType::" " THEN
                                 SETRANGE("Revaluation Category", g_optGLAccountRevalType);

                               IF g_txtGLAccFilter <> '' THEN
                                 SETFILTER("No.",g_txtGLAccFilter);
                               g_intNoOfAccounts := "G/L Account".COUNT;
                               g_intThisAccountNo := 0;

                               gt_recAdjReg.RESET;
                               gt_recAdjReg.DELETEALL;

                               g_cuAdoFunc.OpenSqlConnection('', SqlConnection); // NC NOS-26 SPA

                               //NC MIO-91 > USE
                               g_ICcode:='';
                               //NC MIO-91 < USE
                             END;

               OnAfterGetRecord=VAR
                                  SqlRecordset@1101495015 : DotNet "'System.Data, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Data.SqlClient.SqlDataReader";
                                  l_recDefDim@1101495013 : Record 352;
                                  l_intcount@1101495012 : Integer;
                                  l_decAmount@1101495011 : Decimal;
                                  l_decOrigAmount@1101495010 : Decimal;
                                  l_codeAcc@1101495009 : Code[20];
                                  l_codeCurr@1101495008 : Code[10];
                                  l_codeCurrCB@1101495007 : Code[10];
                                  l_codeDim@1101495006 : Code[20];
                                  l_codeDimVal@1101495005 : Code[20];
                                  l_codeBU@1101495004 : Code[20];
                                  l_blnIsRevaluate@1101495003 : Boolean;
                                  l_blnIsByRevaluate@1101495002 : Boolean;
                                  l_recBusinessUnit@1101495001 : Record 220;
                                  l_optIsRevaluate@1101495000 : ' ,Reval RUR,Reval not RUR,Reval All';
                                  DimensionSetEntry@1101495014 : Record 480;
                                BEGIN
                                  g_intThisAccountNo := g_intThisAccountNo + 1;
                                  g_intMaxEntry :=1;
                                  g_intEntryCount:=0;
                                  IF GUIALLOWED THEN BEGIN
                                    g_dlgWindow.UPDATE(1,"No.");
                                    g_dlgWindow.UPDATE(4,ROUND(g_intThisAccountNo / g_intNoOfAccounts * 10000,1));
                                    g_dlgWindow.UPDATE(3,ROUND(g_intEntryCount / g_intMaxEntry * 10000,1));
                                    g_dlgWindow.UPDATE(6,Text50011);
                                  END;

                                  //NC NCS-1553 > DP
                                  IF Blocked THEN
                                    CurrReport.SKIP;
                                  //NC NCS-1553 < DP


                                  //NC MIO-35 > DP
                                  //NC MIO-94 > USE
                                  {
                                  //NC MIO-88 > USE
                                  {
                                  IF NOT (("Exchange Rate Adjustment"="Exchange Rate Adjustment"::"Adjust Additional-Currency Amount") OR
                                  //TDRANCS-1594>
                                    {
                                    Revaluate) THEN
                                    }
                                    ((g_recCompany."Posting Type"=g_recCompany."Posting Type"::GAAP) AND
                                    (Revaluate=Revaluate::GAAP)) OR
                                    ((g_recCompany."Posting Type"=g_recCompany."Posting Type"::IFRS) AND
                                    (Revaluate=Revaluate::IFRS)) OR
                                    (Revaluate=Revaluate::IFRS_GAAP)
                                    //NC MIO-46 > DP
                                    OR  "Revaluate CB") THEN
                                    //NC MIO-46 < DP
                                  //TDRANCS-1594
                                  }
                                  IF NOT ("Revaluate CB") THEN
                                  //NC MIO-88 < USE
                                  }
                                  IF "Revaluate CB"="Revaluate CB"::" " THEN
                                  //NC MIO-94 < USE
                                    CurrReport.SKIP;
                                  //NC MIO-35 < DP

                                  //получение набора данных из хранимой процедуры td_AccFxBalance
                                  //NC NCS-612 > RD
                                  g_cuAdoFunc.fn_GetAdo3(COMPANYNAME,"No.",g_dateIndex,g_codeCurrCodeFilter,SqlConnection,SqlRecordset,
                                                                //NC MIO-35 > DP
                                                                g_blnIsByBusinessUnit
                                                                //NC MIO-35 < DP
                                                                );
                                  //NC NCS-612 < RD

                                  //l_intcount := l_RecSet.RecordCount;
                                  IF GUIALLOWED THEN
                                    g_dlgWindow.UPDATE(6,Text50012);

                                  //IF l_intcount > 0 THEN BEGIN
                                  IF SqlRecordset.HasRows THEN BEGIN
                                    //g_intMaxEntry := l_intcount;
                                    g_intEntryCount := 0;
                                    IF GUIALLOWED THEN;
                                      g_dlgWindow.UPDATE(3,ROUND(g_intEntryCount / g_intMaxEntry * 10000,1));

                                    //l_RecSet.MoveFirst;
                                    //WHILE NOT l_RecSet.EOF() DO BEGIN
                                    WHILE SqlRecordset.Read DO BEGIN
                                      //NC MIO-94.3 > USE
                                      g_ICcode:='';
                                      //NC MIO-94.3 < USE

                                      g_intEntryCount += 1;
                                      IF GUIALLOWED THEN;
                                        g_dlgWindow.UPDATE(3,ROUND(g_intEntryCount / g_intMaxEntry * 10000,1));
                                      //l_codeAcc := g_cuAdoFunc.VarToText(l_RecSet.Fields().Item('Acc').Value);
                                      l_codeAcc := FORMAT(SqlRecordset.Item('Acc'));

                                      //NC MIO-35 > DP
                                      //l_codeBU :=g_cuAdoFunc.VarToText(l_RecSet.Fields().Item('BU').Value);
                                      l_codeBU := FORMAT(SqlRecordset.Item('BU'));
                                      //NC MIO-35 < DP

                                      //l_codeCurr :=      g_cuAdoFunc.VarToText(l_RecSet.Fields().Item('Curr').Value);
                                      //l_decAmount := ROUND(g_cuAdoFunc.VarToDec(l_RecSet.Fields().Item('Amount').Value));
                                      //l_decOrigAmount := ROUND(g_cuAdoFunc.VarToDec(l_RecSet.Fields().Item('OriginalAmount').Value));
                                      l_codeCurr := FORMAT(SqlRecordset.Item('Curr'));
                                      IF NOT EVALUATE(l_decAmount, FORMAT(SqlRecordset.Item('Amount'))) THEN
                                        EVALUATE(l_decAmount, FORMAT(SqlRecordset.Item('Amount')), 9);
                                      IF NOT EVALUATE(l_decOrigAmount, FORMAT(SqlRecordset.Item('OriginalAmount'))) THEN
                                        EVALUATE(l_decOrigAmount, FORMAT(SqlRecordset.Item('OriginalAmount')), 9);

                                      //NC MIO-35 > DP
                                      l_blnIsRevaluate := FALSE;
                                      l_blnIsByRevaluate := FALSE;
                                      IF l_codeBU<>'' THEN BEGIN
                                        IF l_recBusinessUnit.GET(l_codeBU)  AND
                                        ((l_recBusinessUnit."Currency Code"=g_recGLSetup."LCY Code") OR (l_recBusinessUnit."Currency Code"='')) THEN BEGIN
                                          //TDRANCS-1594 <
                                          {
                                          l_blnIsRevaluate := "G/L Account".Revaluate;
                                          }
                                          l_blnIsRevaluate :=
                                          (((g_recCompany."Posting Type"=g_recCompany."Posting Type"::GAAP) AND (Revaluate=Revaluate::GAAP)) OR
                                          ((g_recCompany."Posting Type"=g_recCompany."Posting Type"::IFRS) AND (Revaluate=Revaluate::IFRS)) OR
                                          (Revaluate=Revaluate::IFRS_GAAP));
                                          //NC MIO-46 > DP
                                          IF l_blnIsRevaluate THEN
                                            //NC MIO-94 > USE
                                            {
                                            l_blnIsRevaluate := "G/L Account"."Revaluate CB";
                                            }
                                            l_blnIsRevaluate := ("G/L Account"."Revaluate CB"="G/L Account"."Revaluate CB"::"Reval RUR") OR
                                                                  ("G/L Account"."Revaluate CB"="G/L Account"."Revaluate CB"::"Reval All");
                                            //NC MIO-94 < USE
                                          //NC MIO-46 < DP
                                          //TDRANCS-1594 <
                                          l_blnIsByRevaluate := TRUE;
                                        END;
                                        IF l_recBusinessUnit.GET(l_codeBU)  AND (l_recBusinessUnit."Currency Code"<>g_recGLSetup."LCY Code") AND
                                        (l_recBusinessUnit."Currency Code"<>'') AND
                                        ("G/L Account"."Exchange Rate Adjustment" ="G/L Account"."Exchange Rate Adjustment"::"Adjust Additional-Currency Amount")
                                        THEN BEGIN
                                           //NC MIO-94 > USE
                                           {
                                           l_blnIsRevaluate := TRUE;
                                           }
                                           l_blnIsRevaluate := ("G/L Account"."Revaluate CB"="G/L Account"."Revaluate CB"::"Reval not RUR") OR
                                                                  ("G/L Account"."Revaluate CB"="G/L Account"."Revaluate CB"::"Reval All");
                                           //NC MIO-94 < USE
                                           l_blnIsByRevaluate := FALSE;
                                        END;
                                      END ELSE BEGIN
                                        //TDRANCS-1594 >
                                        IF ((g_recCompany."Posting Type"=g_recCompany."Posting Type"::GAAP) AND
                                          ("G/L Account".Revaluate="G/L Account".Revaluate::GAAP)) OR
                                          ((g_recCompany."Posting Type"=g_recCompany."Posting Type"::IFRS) AND
                                          ("G/L Account".Revaluate="G/L Account".Revaluate::IFRS)) OR
                                          ("G/L Account".Revaluate="G/L Account".Revaluate::IFRS_GAAP) THEN BEGIN
                                         {
                                         IF "G/L Account".Revaluate THEN BEGIN
                                         }
                                         //TDRANCS-1594 <
                                          //NC MIO-94 > USE
                                          {
                                          //NC MIO-46 > DP
                                          IF "G/L Account"."Revaluate CB" THEN BEGIN
                                          //NC MIO-46 < DP
                                          }
                                          IF "G/L Account"."Revaluate CB"<>"G/L Account"."Revaluate CB"::" " THEN BEGIN
                                          //NC MIO-94 < USE
                                            l_blnIsRevaluate := TRUE;
                                            l_blnIsByRevaluate := TRUE;
                                          END;
                                        END;
                                      END;
                                      IF l_blnIsRevaluate THEN BEGIN
                                      //NC MIO-35 < DP


                                      //NC MIO-85.2 > DP
                                      {
                                      IF ((l_decAmount <> 0) OR (l_decOrigAmount <> 0)) AND (l_codeCurr<>'') THEN BEGIN

                                      }
                                      IF (((l_decAmount <> 0) OR (l_decOrigAmount <> 0)) AND (l_codeCurr<>''))
                                      OR ((l_decAmount <> l_decOrigAmount) AND (l_codeCurr='') AND g_blnIsByBusinessUnit) THEN BEGIN
                                        IF l_codeCurr<>'' THEN BEGIN
                                      //NC MIO-85.2 < DP

                                        IF NOT g_recCurrency.GET(l_codeCurr) THEN
                                          ERROR(Text50003,g_recCurrency.TABLECAPTION,l_codeCurr);
                                        // Замена кода валюты на соотв. код валюты ЦБ >
                                        IF NOT g_recCurrency.GET(g_recCurrency."CB Currency Code") THEN
                                          ERROR(Text50014,g_recCurrency.TABLECAPTION,g_recCurrency.FIELDCAPTION("CB Currency Code"), l_codeCurr)
                                        ELSE
                                          l_codeCurrCB := g_recCurrency.Code;
                                        // <

                                        g_decExchRate := g_recCurrExchRate.ExchangeRate(g_dateIndex,l_codeCurrCB);
                                        g_decAmountLCY := ROUND(g_recCurrExchRate.ExchangeAmtFCYToLCY(g_dateIndex,l_codeCurrCB,l_decOrigAmount,g_decExchRate));

                                        //NC MIO-85.2 > DP
                                        END ELSE BEGIN
                                           g_recCurrency.GET(g_recGLSetup."LCY Code");
                                           g_decAmountLCY :=l_decOrigAmount;
                                        END;
                                        //NC MIO-85.2 < DP

                                        IF g_decAmountLCY <> l_decAmount THEN BEGIN
                                          g_recGenJnlLine.INIT;
                                          g_recGenJnlLine."Journal Template Name" := g_codeTemplate;
                                          g_recGenJnlLine."Journal Batch Name" := g_codeBatch;
                                          g_recGenJnlLine."Line No." :=
                                            fn_GetNextLineNo(g_recGenJnlLine."Journal Template Name",g_recGenJnlLine."Journal Batch Name");
                                          g_recGenJnlLine."Posting Date":= g_dateIndex;
                                          g_recGenJnlLine."Document No.":= g_codeDocumentNo;
                                          g_recGenJnlLine."Account Type":= g_recGenJnlLine."Account Type"::"G/L Account";
                                          g_recGenJnlLine."Account No." := l_codeAcc;
                                          g_recGenJnlLine."Not Consolidate" := g_recStandParam."Not Consolidate";

                                          g_recGenJnlLine."Bal. Account Type":= g_recGenJnlLine."Account Type"::"G/L Account";

                                          //NC MIO-35 > DP
                                          IF l_blnIsByRevaluate  THEN BEGIN
                                          //NC MIO-35 < DP

                                          IF ROUND(g_decAmountLCY - l_decAmount) > 0 THEN BEGIN
                                            IF "G/L Account"."Adjust Credit Acc." <> '' THEN
                                              g_recGenJnlLine."Bal. Account No.":="G/L Account"."Adjust Credit Acc."
                                            ELSE
                                              IF g_recCurrency."Unrealized Gains Acc." <> '' THEN
                                                g_recGenJnlLine."Bal. Account No.":=g_recCurrency."Unrealized Gains Acc."
                                              ELSE ERROR(Text50004,"G/L Account".FIELDCAPTION("Adjust Credit Acc."),"G/L Account".TABLECAPTION,l_codeAcc,
                                                                 g_recCurrency.FIELDCAPTION("Unrealized Gains Acc."),g_recCurrency.TABLECAPTION,l_codeCurr);
                                          END ELSE BEGIN
                                            IF "G/L Account"."Adjust Debit Acc." <> '' THEN
                                              g_recGenJnlLine."Bal. Account No.":="G/L Account"."Adjust Debit Acc."
                                            ELSE
                                              IF g_recCurrency."Unrealized Losses Acc." <> '' THEN
                                                g_recGenJnlLine."Bal. Account No." := g_recCurrency."Unrealized Losses Acc."
                                              ELSE ERROR(Text50004,"G/L Account".FIELDCAPTION("Adjust Debit Acc."),"G/L Account".TABLECAPTION,l_codeAcc,
                                                                 g_recCurrency.FIELDCAPTION("Unrealized Losses Acc."),g_recCurrency.TABLECAPTION,l_codeCurr);
                                          END;

                                          //NC MIO-35 > DP
                                          END ELSE
                                          IF (COMPANYNAME <> 'Standard Bank')  THEN BEGIN
                                          {
                                          //TDRANCS-609>
                                          IF (g_recGLSetup."LCY Code" <> g_recGLSetup."Revaluate To Curr. Code")
                                            AND (g_recGLSetup."Revaluate To Curr. Code" <> '')
                                            AND (COMPANYNAME <> 'Standard Bank')  THEN BEGIN
                                          }
                                          //NC MIO-35 < DP

                                              IF "Transl. Effect G/L Acc. No." <> '' THEN
                                                g_recGenJnlLine."Bal. Account No.":="G/L Account"."Transl. Effect G/L Acc. No."
                                              ELSE
                                                IF (g_recCurrency."Transform Effect Acc." <> '') THEN
                                                  g_recGenJnlLine."Bal. Account No.":= g_recCurrency."Transform Effect Acc."
                                                ELSE ERROR(Text50004,FIELDCAPTION("Transl. Effect G/L Acc. No."),TABLECAPTION,l_codeAcc,
                                                                g_recCurrency.FIELDCAPTION("Transform Effect Acc."),g_recCurrency.TABLECAPTION,l_codeCurr);
                                          END;
                                          //TDRANCS-609<

                                          g_recGenJnlLine.Description := g_txtPostingDescription;
                                          g_recGenJnlLine."Reason Code":= g_recGenJnlBatch."Reason Code";
                                          g_recGenJnlLine."Currency Index Entry":=TRUE;
                                          g_recGenJnlLine."Currency Index" := l_codeCurr;
                                          g_recGenJnlLine."Source Code" := g_recSourceCodeSetup."FX Revaluation CB";

                                          //NC MIO-35 > DP
                                          IF NOT "G/L Account"."Direct Posting" THEN
                                          g_recGenJnlLine."System-Created Entry" := TRUE;
                                          //NC MIO-35 < DP

                                          //NC MIO-35 > DP
                                          IF l_codeBU<>'' THEN
                                            g_recGenJnlLine."Business Unit Code":= l_codeBU
                                          ELSE
                                          //NC MIO-35 < DP

                                          g_recGenJnlLine."Business Unit Code":= g_codeBusUnitCode;
                                          g_recGenJnlLine.VALIDATE(Amount,ROUND(g_decAmountLCY - l_decAmount));
                                          g_decDeltaAmount := g_decDeltaAmount + ROUND(g_decAmountLCY - l_decAmount);

                                          l_codeDim := g_recGLSetup."Global Dimension 1 Code";
                                          l_codeDimVal := '';
                                          IF l_recDefDim.GET(DATABASE::"G/L Account","G/L Account"."No.",l_codeDim) THEN
                                            IF l_recDefDim."Value Posting" IN
                                               [l_recDefDim."Value Posting"::"Code Mandatory", l_recDefDim."Value Posting"::"Same Code"]
                                            THEN BEGIN
                                              l_codeDim :=CONVERTSTR(l_codeDim,'.','_');
                                              //l_codeDimVal := g_cuAdoFunc.VarToText(l_RecSet.Fields().Item(l_codeDim).Value);
                                              l_codeDimVal := FORMAT(SqlRecordset.Item(l_codeDim));
                                              g_recGenJnlLine."Shortcut Dimension 1 Code":='';
                                              IF FIELDACTIVE("Global Dimension 1 Code") AND g_boolClosePerGlobalDim1 THEN BEGIN
                                                IF l_codeDimVal<>'' THEN
                                                  g_recGenJnlLine."Shortcut Dimension 1 Code":=l_codeDimVal;
                                              END;
                                            END;

                                          l_codeDim := g_recGLSetup."Global Dimension 2 Code";
                                          l_codeDimVal := '';
                                          IF l_recDefDim.GET(DATABASE::"G/L Account","G/L Account"."No.",l_codeDim) THEN
                                            IF l_recDefDim."Value Posting" IN
                                               [l_recDefDim."Value Posting"::"Code Mandatory", l_recDefDim."Value Posting"::"Same Code"] THEN BEGIN
                                              l_codeDim :=CONVERTSTR(l_codeDim,'.','_');
                                              //l_codeDimVal := g_cuAdoFunc.VarToText(l_RecSet.Fields().Item(l_codeDim).Value);
                                              l_codeDimVal := FORMAT(SqlRecordset.Item(l_codeDim));
                                              g_recGenJnlLine."Shortcut Dimension 2 Code":='';
                                              IF FIELDACTIVE("Global Dimension 2 Code") AND g_boolClosePerGlobalDim2 THEN BEGIN
                                                IF l_codeDimVal<>'' THEN
                                                  g_recGenJnlLine."Shortcut Dimension 2 Code":=l_codeDimVal;
                                              END;
                                            END;

                                          // TDRANCS-702>
                                          g_recGenJnlLine."Check Printed" := FALSE;
                                          g_recGenJnlLine."Transaction Type" := g_recGenJnlBatch."Batch Type";
                                          // TDRANCS-702<


                                          IF NOT (g_recGenJnlLine."Amount (LCY)" = 0) THEN BEGIN
                                            fn_CopyRecSetDimToJnlLineDim(SqlRecordset,g_recGenJnlLine);
                                            fn_CopySelectedDimToJnlLineDim(gt_recSelectedDimNew,g_recGenJnlLine);
                                            // TDRANCS-702>

                                            //g_recGenJnlLine.INSERT(TRUE);
                                            g_recGenJnlLine.INSERT;

                                            // TDRANCS-702<
                                            l_intcount := 1;


                                            IF DimensionSetEntry.GET(g_recGenJnlLine."Dimension Set ID", g_recMovSetup."FI Dimension Code") THEN BEGIN
                                  //          IF g_recJnlLineDim.GET(DATABASE::"Gen. Journal Line",g_recGenJnlLine."Journal Template Name",
                                  //            g_recGenJnlLine."Journal Batch Name",g_recGenJnlLine."Line No.",0,g_recMovSetup."FI Dimension Code")
                                  //          THEN BEGIN
                                  //            g_recGenJnlLine."Financial Instrument No." := g_recJnlLineDim."Dimension Value Code";
                                              g_recGenJnlLine."Financial Instrument No." := DimensionSetEntry."Dimension Value Code";

                                              //NC MIO-94.2 > USE Временно исключаем для переноса на рабочую базу
                                              {
                                              //NC NCS-1250 > DP
                                              //NC MIO-94.1 > USE
                                              {
                                              IF "Equity Revaluation" AND g_FI.GET(g_recGenJnlLine."Financial Instrument No.") THEN
                                              }
                                              IF l_blnIsByRevaluate AND "Equity Revaluation" AND g_FI.GET(g_recGenJnlLine."Financial Instrument No.") THEN
                                              //NC MIO-94.1 < USE
                                                IF g_FIType.GET(g_FI."Type FI") THEN  BEGIN
                                                  IF (g_recGenJnlLine.Amount >0) AND (g_FIType."Adjust Credit Acc. No."<>'') THEN
                                                    g_recGenJnlLine."Bal. Account No." := g_FIType."Adjust Credit Acc. No.";
                                                  IF (g_recGenJnlLine.Amount <0) AND (g_FIType."Adjust Debit Acc. No."<>'') THEN
                                                    g_recGenJnlLine."Bal. Account No." := g_FIType."Adjust Debit Acc. No.";
                                                END;
                                              //NC NCS-1250 < DP
                                              }
                                              //NC MIO-94.2 > USE
                                              g_recGenJnlLine.MODIFY(TRUE);
                                            END;

                                            //NC MIO-91 > USE
                                            IF (g_ICcode<>'') AND (g_recCompany."Company Type"=g_recCompany."Company Type"::Consolidation) THEN BEGIN
                                              //NC MIO-94 > USE
                                              {
                                              IF (l_recBusinessUnit.GET(l_codeBU)  AND (l_recBusinessUnit."Currency Code"<>g_recGLSetup."LCY Code")) THEN
                                                g_recGenJnlLine."Bal. Account No.":="G/L Account"."Transl. Effect G/L Acc. No."
                                              ELSE IF l_recBusinessUnit.GET(g_ICcode)  AND (l_recBusinessUnit."Currency Code"<>g_recGLSetup."LCY Code") THEN
                                                g_recGenJnlLine."Bal. Account No.":="G/L Account"."Adjust Acc. CB";
                                              }
                                              IF l_recBusinessUnit.GET(l_codeBU)  AND
                                                  ((l_recBusinessUnit."Currency Code"=g_recGLSetup."LCY Code") OR (l_recBusinessUnit."Currency Code"='')) THEN
                                                IF l_recBusinessUnit.GET(g_ICcode)  AND

                                                  //NC NCS-2526 > DP
                                                  {
                                                  ((l_recBusinessUnit."Currency Code"=g_recGLSetup."LCY Code") OR (l_recBusinessUnit."Currency Code"='')) THEN BEGIN
                                                  }
                                                  (l_recBusinessUnit."Currency Code"<>g_recGLSetup."LCY Code") AND (l_recBusinessUnit."Currency Code"<>'') THEN BEGIN
                                                  //NC NCS-2526 < DP
                                                  IF "G/L Account"."FX IG Different LCY Account"='' THEN
                                                    //NC NCS-2493 > DP
                                                    ERROR(Text50015,
                                                    "G/L Account".FIELDCAPTION("FX IG Different LCY Account"),
                                                    "G/L Account".TABLECAPTION,"G/L Account"."No.");
                                                    //NC NCS-2493 < DP
                                                  g_recGenJnlLine."Bal. Account No.":="G/L Account"."FX IG Different LCY Account";
                                                END;
                                              //NC MIO-94 < USE
                                              g_recGenJnlLine.MODIFY(TRUE);
                                            END;
                                            //NC MIO-94.3 > USE
                                            {
                                            g_ICcode:='';
                                            }
                                            //NC MIO-94.3 < USE
                                            //NC MIO-91 < USE
                                          END;

                                          // Реверс операций >
                                          // Закоментировано 22/06/11 по требованию А.Корневой - реверс сейчас не нужен
                                          {
                                          g_recGenJnlLine."Line No." :=
                                            fn_GetNextLineNo(g_recGenJnlLine."Journal Template Name",g_recGenJnlLine."Journal Batch Name");
                                          g_recGenJnlLine.VALIDATE(Amount,-1 * g_recGenJnlLine.Amount);
                                          g_recGenJnlLine."Posting Date" := CALCDATE('<+1D>',g_dateIndex);
                                          g_recGenJnlLine.Description := 'Reverse ' + g_recGenJnlLine.Description;

                                          IF NOT (g_recGenJnlLine."Amount (LCY)" = 0) THEN BEGIN
                                            fn_CopyRecSetDimToJnlLineDim(l_RecSet,g_recJnlLineDim,g_recGenJnlLine);
                                            fn_CopySelectedDimToJnlLineDim(gt_recSelectedDimNew,g_recJnlLineDim,g_recGenJnlLine);

                                            // TDRANCS-702>

                                            //g_recGenJnlLine.INSERT(TRUE);
                                            g_recGenJnlLine.INSERT;

                                            // TDRANCS-702<

                                            IF g_recJnlLineDim.GET(DATABASE::"Gen. Journal Line",g_recGenJnlLine."Journal Template Name",
                                              g_recGenJnlLine."Journal Batch Name",g_recGenJnlLine."Line No.",0,g_recMovSetup."FI Dimension Code")
                                            THEN BEGIN
                                              g_recGenJnlLine."Financial Instrument No." := g_recJnlLineDim."Dimension Value Code";
                                              g_recGenJnlLine.MODIFY(TRUE);
                                            END;
                                          END;
                                          // Реверс операций <
                                          }
                                        END;

                                        IF ROUND(g_decAmountLCY - l_decAmount)<>0 THEN
                                        WITH gt_recAdjReg DO BEGIN
                                          RESET;
                                          SETRANGE("Creation Date",g_dateIndex);
                                          SETRANGE("Account Type","Account Type"::"G/L Account");
                                          SETRANGE("Posting Group",l_codeAcc);
                                          SETRANGE("Currency Code",l_codeCurr);
                                          SETRANGE("Revalution Type",g_recExchRateAdjReg."Revalution Type"::FX);
                                          IF FINDFIRST THEN BEGIN
                                            "Adjusted Base"+=l_decOrigAmount;
                                            "Adjusted Base (LCY)"+=l_decAmount;
                                            "Adjusted Amt. (LCY)" += (g_decAmountLCY - l_decAmount);
                                            MODIFY(TRUE);
                                          END ELSE BEGIN
                                            INIT;
                                            "No." := g_intAdjRegTmpCnt;
                                            "Creation Date" :=g_dateIndex;
                                            "Account Type" := "Account Type"::"G/L Account";
                                            "Posting Group" := l_codeAcc;
                                            "Currency Code" := l_codeCurr;
                                            "Revalution Type" := g_recExchRateAdjReg."Revalution Type"::FX;
                                            "Currency Factor" := g_decExchRate;
                                            "Adjusted Base":=l_decOrigAmount;
                                            "Adjusted Base (LCY)":=l_decAmount;
                                            "Adjusted Amt. (LCY)" := (g_decAmountLCY - l_decAmount);
                                            IF INSERT(TRUE) THEN
                                              g_intAdjRegTmpCnt += 1;
                                          END;
                                        END;

                                      END;

                                      //NC MIO-35 > DP
                                      END;
                                      //NC MIO-35 < DP
                                    END;
                                  END;

                                  SqlRecordset.Close;
                                END;

               OnPostDataItem=BEGIN
                                g_recExchRateAdjReg.RESET;
                                IF g_recExchRateAdjReg.FINDLAST THEN
                                  g_intAdjRegTmpCnt := g_recExchRateAdjReg."No."+1
                                ELSE
                                  g_intAdjRegTmpCnt := 1;

                                gt_recAdjReg.RESET;
                                IF gt_recAdjReg.FINDFIRST THEN
                                REPEAT
                                  g_recExchRateAdjReg.INIT;
                                  g_recExchRateAdjReg.TRANSFERFIELDS(gt_recAdjReg,FALSE);
                                  g_recExchRateAdjReg."No." := g_intAdjRegTmpCnt;
                                  IF g_recExchRateAdjReg.INSERT(TRUE) THEN
                                    g_intAdjRegTmpCnt += 1;
                                UNTIL gt_recAdjReg.NEXT=0;

                                g_cuAdoFunc.CloseSqlConnection(SqlConnection);
                              END;
                               }

  }
  REQUESTPAGE
  {
    PROPERTIES
    {
    }
    CONTROLS
    {
      { 1101495000;;Container;
                  ContainerType=ContentArea }

      { 1101495001;1;Field  ;
                  CaptionML=[ENU=Revaluation Category;
                             RUS=Категория Переоценки];
                  OptionCaptionML=[ENU=" ,Cash,FI,Receivable,Payable,Loan Receivable,Loan Payable";
                                   RUS=" ,Денеж. Средства,Фин. Инструменты,Дебиторы,Кредиторы,Кредиты Выданные,Кредиты Привлеченные"];
                  SourceExpr=g_optGLAccountRevalType }

      { 1101495002;1;Field  ;
                  CaptionML=[ENU=GL  Acc. Filter;
                             RUS=Фин. Счет Фильтр];
                  SourceExpr=g_txtGLAccFilter;
                  OnLookup=BEGIN
                             IF g_optGLAccountRevalType <> g_optGLAccountRevalType::" " THEN
                               g_recGLAccount.SETRANGE(g_recGLAccount."Revaluation Category", g_optGLAccountRevalType);

                             IF PAGE.RUNMODAL(0, g_recGLAccount) = ACTION::LookupOK THEN
                               Text +=  g_recGLAccount."No.";
                             g_txtGLAccFilter := Text;
                             EXIT(TRUE);
                           END;
                            }

      { 1101495003;1;Field  ;
                  CaptionML=[ENU=Revaluation Date;
                             RUS=Дата Переоценки];
                  SourceExpr=g_dateIndex;
                  OnValidate=BEGIN
                               IF g_dateIndex <> 0D THEN
                                 g_codeDocumentNo := g_recStandParam."Prefix Numbers" + FORMAT(g_dateIndex,0,9);
                             END;
                              }

      { 1101495004;1;Field  ;
                  CaptionML=[ENU=Gen. Journal Template;
                             RUS=Фин. Журнал Шаблон];
                  SourceExpr=g_codeTemplate;
                  TableRelation="Gen. Journal Template" }

      { 1101495005;1;Field  ;
                  CaptionML=[ENU=Gen. Journal Batch.;
                             RUS=Фин. Журнал Раздел];
                  SourceExpr=g_codeBatch;
                  OnValidate=BEGIN
                               //NC PIF001 > DP
                               IF g_codeBatch <> '' THEN BEGIN
                                 g_recGenJnlBatch.GET(g_codeTemplate, g_codeBatch);
                               END;
                               //NC PIF001 < DP
                             END;

                  OnLookup=BEGIN
                             //NC PIF001 > DP
                             g_recGenJnlBatch.SETRANGE("Journal Template Name", g_codeTemplate);
                             IF PAGE.RUNMODAL(PAGE::"General Journal Batches", g_recGenJnlBatch) = ACTION::LookupOK THEN BEGIN
                               g_codeBatch := g_recGenJnlBatch.Name;
                             END;
                             //NC PIF001 < DP
                           END;
                            }

      { 1101495006;1;Field  ;
                  CaptionML=[ENU=Document No.;
                             RUS=Документ Но.];
                  SourceExpr=g_codeDocumentNo }

      { 1101495007;1;Field  ;
                  CaptionML=[ENU=Posting Description;
                             RUS=Описание Учета];
                  SourceExpr=g_txtPostingDescription }

      { 1101495008;1;Field  ;
                  CaptionML=[ENU=Currency Code;
                             RUS=Код Валюты];
                  SourceExpr=g_codeCurrCodeFilter;
                  OnLookup=BEGIN
                             IF PAGE.RUNMODAL(0, g_recCurrency) = ACTION::LookupOK THEN
                               Text +=  g_recCurrency.Code;
                             g_codeCurrCodeFilter := Text;
                             EXIT(TRUE);
                           END;
                            }

      { 1101495009;1;Field  ;
                  CaptionML=[ENU=Add Dimensions;
                             RUS=Добавить измерения];
                  SourceExpr=g_txtColumnDim;
                  Editable=FALSE;
                  OnAssistEdit=VAR
                                 DimSelectionBuf@1101495000 : Record 368;
                               BEGIN
                                 DimSelectionBuf.SetDimSelectionChange(3,REPORT::"Adjust Local Currency CB",g_txtColumnDim);
                               END;
                                }

      { 1101495010;1;Field  ;
                  CaptionML=[ENU=Group by Business Unit;
                             RUS=Группировать по Филиалам];
                  SourceExpr=g_blnIsByBusinessUnit }

    }
  }
  LABELS
  {
  }
  CODE
  {
    VAR
      g_recConsSetup@1101495057 : Record 50000;
      g_recMovSetup@1101495056 : Record 50064;
      g_recGLSetup@1101495055 : Record 98;
      g_recStandParam@1101495054 : Record 50076;
      gt_recSelectedDim@1101495053 : TEMPORARY Record 369;
      g_recGenJnlBatch@1101495052 : Record 232;
      g_recSourceCodeSetup@1101495051 : Record 242;
      g_recGenJnlLine@1101495050 : Record 81;
      g_recDimSelectionBuf1@1101495049 : Record 368;
      g_recSelectedDim@1101495048 : Record 369;
      gt_recSelectedDimNew@1101495047 : TEMPORARY Record 369;
      gt_recAdjReg@1101495046 : TEMPORARY Record 86;
      g_recGLAccount@1101495045 : Record 15;
      g_recCurrExchRate@1101495044 : Record 330;
      g_recCurrency@1101495042 : Record 4;
      g_recExchRateAdjReg@1101495041 : Record 86;
      SqlConnection@1101495043 : DotNet "'System.Data, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Data.SqlClient.SqlConnection";
      g_cuLog@1101495040 : Codeunit 50014;
      g_cuAdoFunc@1101495039 : Codeunit 50024;
      DimMgt@1101495058 : Codeunit 408;
      g_repPartPostLine@1101495038 : Report 50023;
      g_intAdjRegTmpCnt@1101495037 : Integer;
      g_intRet@1101495036 : Integer;
      g_intLineMin@1101495035 : Integer;
      g_intLineMax@1101495034 : Integer;
      g_intNoOfAccounts@1101495033 : Integer;
      g_intThisAccountNo@1101495032 : Integer;
      g_intMaxEntry@1101495031 : Integer;
      g_intEntryCount@1101495030 : Integer;
      g_intTestCount@1101495029 : Integer;
      g_decExchRate@1101495028 : Decimal;
      g_decAmountLCY@1101495027 : Decimal;
      g_decDeltaAmount@1101495026 : Decimal;
      g_codeBusUnitCode@1101495025 : Code[20];
      g_codeTemplate@1101495024 : Code[10];
      g_codeBatch@1101495023 : Code[10];
      g_codeDocumentNo@1101495022 : Code[20];
      g_codeCurrCodeFilter@1101495021 : Code[10];
      g_txtColumnDim@1101495020 : Text[250];
      g_txtPostingDescription@1101495019 : Text[50];
      g_txtGLAccFilter@1101495018 : Text[90];
      g_txtConnectionString@1101495017 : Text[500];
      g_dateIndex@1101495016 : Date;
      g_optGLAccountRevalType@1101495015 : ' ,Cash,FI,Receivable,Payable,Loan Receivable,Loan Payable';
      g_boolPost81@1101495014 : Boolean;
      g_boolClosePerGlobalDim1@1101495013 : Boolean;
      g_boolClosePerGlobalDim2@1101495012 : Boolean;
      g_boolClosePerGlobalDimOnly@1101495011 : Boolean;
      g_dlgWindow@1101495010 : Dialog;
      g_Time1@1101495009 : Time;
      g_Time2@1101495008 : Time;
      g_FI@1101495007 : Record 50021;
      g_FIType@1101495006 : Record 50051;
      g_recCompany@1101495005 : Record 2000000006;
      g_recJobPrStatus@1101495004 : Record 50063;
      g_blnIsByBusinessUnit@1101495003 : Boolean;
      g_JobProcLineNo@1101495002 : Integer;
      g_cuDimMgt@1101495001 : Codeunit 408;
      g_ICcode@1101495000 : Code[20];
      Text00001@1101495080 : TextConst 'ENU=Revaluation of foreign currency transactions successfully completed;RUS=Переоценка валютных операций успешно выполнена';
      Text020@1101495079 : TextConst 'ENU=The following %1s have mandatory dimension codes that have not been selected:;RUS=Для следующих %1 заданы обязательные коды измерений, которые не выбраны:';
      Text021@1101495078 : TextConst 'ENU=\\In order to post to these accounts you must also select these dimensions:;RUS=\\Чтобы учесть эти счета, необходимо также выбрать следующие измерения:';
      Text007@1101495077 : TextConst 'ENU=Do you wish to continue?;RUS=Продолжить?';
      Text008@1101495076 : TextConst 'ENU=Creating general journal lines...\\;RUS=Создание строк финансового журнала...\\';
      Text014@1101495075 : TextConst 'ENU=Currency            #5##################\;RUS=Валюта              #5##################\';
      Text009@1101495074 : TextConst 'ENU=#1##################\;RUS=#1##################\';
      Text010@1101495073 : TextConst 'ENU=Now performing      #2##################\;RUS=Выполняется         #2##################\';
      Text011@1101495072 : TextConst 'ENU=@3@@@@@@@@@@@@@@@@@@\;RUS=@3@@@@@@@@@@@@@@@@@@\';
      Text019@1101495071 : TextConst 'ENU=@4@@@@@@@@@@@@@@@@@@\;RUS=@4@@@@@@@@@@@@@@@@@@\';
      Text012@1101495070 : TextConst 'ENU=Creating Gen. Journal lines;RUS=Создание строк фин. журнала';
      Text013@1101495069 : TextConst 'ENU=Calculating Amounts;RUS=Выполняется подсчет сумм';
      Text50002@1101495068 : TextConst 'ENU="Please make settings in ";RUS="Не заполнены настройки в "';
      Text50003@1101495067 : TextConst 'ENU=In %1 not found from previous account %2;RUS=В %1 не найден имевшийся ранее %2';
      Text50004@1101495066 : TextConst 'ENU=Not filled field %1 in %2 for account %3and \field %4 in %5 for currency %6;RUS=Не заполнено поле %1 в %2 для счета %3 и \поле %4 в %5 для валюты %6';
      Text50005@1101495065 : TextConst 'ENU=Recording Gen. Journal successfully created;RUS=Записи в фин. журнале успешно созданы';
      Text50006@1101495064 : TextConst 'ENU=With the given parameters revaluation nothing;RUS=При заданных параметрах переоценивать нечего';
      Text50011@1101495063 : TextConst 'ENU=Submitting Request...;RUS="Отправка запроса...     "';
      Text50012@1101495062 : TextConst 'ENU=Processing ...;RUS="Обработка данных...     "';
      Text50013@1101495061 : TextConst 'ENU=#6##################\;RUS=#6##################\';
      Text50014@1101495060 : TextConst 'ENU=In %1 not found %2 for currency %3;RUS=В %1 не найден %2 для валюты %3';
      Text50015@1101495059 : TextConst 'ENU=Set %1 in %2 for Account No. %3;RUS=Не заполнено поле %1 в таблице %2 для Cчёта Но. %3';

    PROCEDURE fn_GetNextLineNo@1000000008(p_codeGenJnlTemplate@1000000001 : Code[20];p_codeGenJnlBatch@1000000000 : Code[20]) : Integer;
    VAR
      l_recGenJournalLine1@1000000002 : Record 81;
    BEGIN
      IF g_intRet = 0 THEN BEGIN
        l_recGenJournalLine1.SETFILTER("Journal Template Name", p_codeGenJnlTemplate);
        l_recGenJournalLine1.SETFILTER("Journal Batch Name", p_codeGenJnlBatch);
        IF l_recGenJournalLine1.RECORDLEVELLOCKING THEN
          l_recGenJournalLine1.LOCKTABLE;
        IF l_recGenJournalLine1.FIND('+') THEN
          g_intRet := l_recGenJournalLine1."Line No." + 1
        ELSE
          g_intRet := 1;
      END ELSE
        g_intRet += 1;

      IF g_intLineMin=0 THEN
        g_intLineMin := g_intRet;
      g_intLineMax := g_intRet;

      EXIT(g_intRet);
    END;

    PROCEDURE fn_CopySelectedDimToJnlLineDim@1210002(VAR p_recSelectedDim@1210000 : Record 369;VAR p_recGenJnlLine@1210002 : Record 81);
    VAR
      l_recDefDim@1000000002 : Record 352;
      TempDimSetEntry@1101495001 : TEMPORARY Record 480;
      DimensionSetEntry@1101495002 : Record 480;
      l_boolIsNeedModify@1101495000 : Boolean;
    BEGIN
      //NC NOS-26 > SPA
      IF p_recGenJnlLine."Dimension Set ID" <> 0 THEN
        DimMgt.GetDimensionSet(TempDimSetEntry, p_recGenJnlLine."Dimension Set ID");
      TempDimSetEntry.SetObject(p_recGenJnlLine);
      //NC NOS-26 < SPA

      IF p_recSelectedDim.FIND('-') THEN
        REPEAT
          //NC NOS-26 > SPA
          TempDimSetEntry.VALIDATE("Dimension Code", p_recSelectedDim."Dimension Code");
          IF NOT TempDimSetEntry.FIND THEN BEGIN
            TempDimSetEntry.VALIDATE("Dimension Value Code", p_recSelectedDim."New Dimension Value Code");
            TempDimSetEntry.INSERT(TRUE);
          END;

          //NC NOS-26 < SPA
          {
          p_recJnlLineDim.INIT;
          p_recJnlLineDim."Table ID" := DATABASE::"Gen. Journal Line";
          p_recJnlLineDim."Journal Template Name" := p_recGenJnlLine."Journal Template Name";
          p_recJnlLineDim."Journal Batch Name" := p_recGenJnlLine."Journal Batch Name";
          p_recJnlLineDim."Journal Line No." := p_recGenJnlLine."Line No.";
          p_recJnlLineDim."Dimension Code":=p_recSelectedDim."Dimension Code";
          p_recJnlLineDim.VALIDATE("Dimension Value Code",p_recSelectedDim."New Dimension Value Code");
          {
          //этот вариант перезаписывал значения измерений
          IF NOT p_recJnlLineDim.INSERT THEN
            p_recJnlLineDim.MODIFY;
          IF p_recSelectedDim."Dimension Code" = GLSetup."Global Dimension 1 Code" THEN
            p_recGenJnlLine."Shortcut Dimension 1 Code" := p_recSelectedDim."New Dimension Value Code";
          IF p_recSelectedDim."Dimension Code" = GLSetup."Global Dimension 2 Code" THEN
            p_recGenJnlLine."Shortcut Dimension 2 Code" := p_recSelectedDim."New Dimension Value Code";
          }
          //этот вариант только добавляет измерения без модификации уже имеющегося
          IF p_recJnlLineDim.INSERT(TRUE) THEN;
          }
          IF p_recSelectedDim."Dimension Code" = g_recGLSetup."Global Dimension 1 Code" THEN
            IF p_recGenJnlLine."Shortcut Dimension 1 Code" = '' THEN
              p_recGenJnlLine."Shortcut Dimension 1 Code":=p_recSelectedDim."New Dimension Value Code";
          IF p_recSelectedDim."Dimension Code" = g_recGLSetup."Global Dimension 2 Code" THEN
            IF p_recGenJnlLine."Shortcut Dimension 2 Code" = '' THEN
              p_recGenJnlLine."Shortcut Dimension 2 Code":= p_recSelectedDim."New Dimension Value Code";
        UNTIL p_recSelectedDim.NEXT = 0;

      //NC MIO-35.3 > DP
      l_recDefDim.SETRANGE("Table ID",DATABASE::"G/L Account");
      l_recDefDim.SETRANGE("No.",p_recGenJnlLine."Bal. Account No.");
      l_recDefDim.SETFILTER("Dimension Value Code",'<>%1','');
      TempDimSetEntry.SetObject(p_recGenJnlLine); //NC NOS-26 SPA
      IF l_recDefDim.FINDSET THEN
        REPEAT
            l_boolIsNeedModify := TRUE;
            //NC NOS-26 > SPA
            TempDimSetEntry.INIT;
            TempDimSetEntry.VALIDATE("Dimension Code", l_recDefDim."Dimension Code");
            //варианты перезаписи измерений в зависимости от типа учета значения
            CASE l_recDefDim."Value Posting" OF
              l_recDefDim."Value Posting"::"Same Code": BEGIN
                IF TempDimSetEntry.FIND THEN
                  TempDimSetEntry.DELETE;
                TempDimSetEntry.VALIDATE("Dimension Value Code", l_recDefDim."Dimension Value Code");
                TempDimSetEntry.INSERT(TRUE);
              END;

              ELSE BEGIN
                IF TempDimSetEntry.FIND THEN
                  IF TempDimSetEntry."Dimension Value Code" = '' THEN BEGIN
                    TempDimSetEntry.DELETE;
                    TempDimSetEntry.VALIDATE("Dimension Value Code", l_recDefDim."Dimension Value Code");
                    TempDimSetEntry.INSERT(TRUE);
                  END ELSE
                    l_boolIsNeedModify := FALSE;

                {
                IF l_recJnlLineDim2.GET(p_recJnlLineDim."Table ID",p_recJnlLineDim."Journal Template Name",
                  p_recJnlLineDim."Journal Batch Name",
                  p_recJnlLineDim."Journal Line No.",p_recJnlLineDim."Allocation Line No.",
                  p_recJnlLineDim."Dimension Code")
                THEN
                  IF l_recJnlLineDim2."Dimension Value Code" = '' THEN
                    p_recJnlLineDim.MODIFY(TRUE)
                  ELSE
                    l_boolIsNeedModify := FALSE;
                }
              END;
            END;
            //NC NOS-26 < SPA
            {
            p_recJnlLineDim.INIT;
            p_recJnlLineDim."Table ID" := DATABASE::"Gen. Journal Line";
            p_recJnlLineDim."Journal Template Name" := p_recGenJnlLine."Journal Template Name";
            p_recJnlLineDim."Journal Batch Name" := p_recGenJnlLine."Journal Batch Name";
            p_recJnlLineDim."Journal Line No." := p_recGenJnlLine."Line No.";
            p_recJnlLineDim."Dimension Code":=l_recDefDim."Dimension Code";
            p_recJnlLineDim.VALIDATE("Dimension Value Code",l_recDefDim."Dimension Value Code");
            IF NOT p_recJnlLineDim.INSERT(TRUE) THEN
              //варианты перезаписи измерений в зависимости от типа учета значения
              CASE l_recDefDim."Value Posting" OF
                l_recDefDim."Value Posting"::"Same Code": p_recJnlLineDim.MODIFY(TRUE);
                ELSE
                  IF l_recJnlLineDim2.GET(p_recJnlLineDim."Table ID",p_recJnlLineDim."Journal Template Name",
                      p_recJnlLineDim."Journal Batch Name",
                      p_recJnlLineDim."Journal Line No.",p_recJnlLineDim."Allocation Line No.",
                      p_recJnlLineDim."Dimension Code") THEN
                    IF l_recJnlLineDim2."Dimension Value Code"='' THEN
                      p_recJnlLineDim.MODIFY(TRUE)
                    ELSE
                      l_boolIsNeedModify := FALSE;
              END;
            }
            IF (l_recDefDim."Dimension Code" = g_recGLSetup."Global Dimension 1 Code") AND l_boolIsNeedModify THEN
              p_recGenJnlLine."Shortcut Dimension 1 Code":= l_recDefDim."Dimension Value Code";

            IF (l_recDefDim."Dimension Code" = g_recGLSetup."Global Dimension 2 Code") AND l_boolIsNeedModify THEN
              p_recGenJnlLine."Shortcut Dimension 2 Code":=l_recDefDim."Dimension Value Code";

        UNTIL l_recDefDim.NEXT=0;
      //NC MIO-35.3 < DP

      //Измерения из стандартных настроек
      l_recDefDim.RESET;
      l_recDefDim.SETRANGE("Table ID",DATABASE::"Period. Activities Stand. Par.");
      l_recDefDim.SETRANGE("No.",g_recStandParam.Code);
      TempDimSetEntry.SetObject(p_recGenJnlLine);
      IF l_recDefDim.FINDSET THEN REPEAT
        IF l_recDefDim."Dimension Value Code" <> '' THEN BEGIN
          l_boolIsNeedModify := TRUE;
          //NC NOS-26 > SPA
          TempDimSetEntry.INIT;
          TempDimSetEntry.VALIDATE("Dimension Code", l_recDefDim."Dimension Code");
          CASE l_recDefDim."Value Posting" OF
            l_recDefDim."Value Posting"::"Code Mandatory": BEGIN
              IF TempDimSetEntry.FIND THEN
                TempDimSetEntry.DELETE;
              TempDimSetEntry.VALIDATE("Dimension Value Code", l_recDefDim."Dimension Value Code");
              TempDimSetEntry.INSERT(TRUE);
            END;

            ELSE BEGIN
              IF TempDimSetEntry.FIND THEN
                IF TempDimSetEntry."Dimension Value Code" = '' THEN BEGIN
                  TempDimSetEntry.DELETE;
                  TempDimSetEntry.VALIDATE("Dimension Value Code", l_recDefDim."Dimension Value Code");
                  TempDimSetEntry.INSERT(TRUE);
                END ELSE
                  l_boolIsNeedModify := FALSE;
            END;
          END;
          //NC NOS-26 < SPA
          {
          p_recJnlLineDim.INIT;
          p_recJnlLineDim."Table ID" := DATABASE::"Gen. Journal Line";
          p_recJnlLineDim."Journal Template Name" := p_recGenJnlLine."Journal Template Name";
          p_recJnlLineDim."Journal Batch Name" := p_recGenJnlLine."Journal Batch Name";
          p_recJnlLineDim."Journal Line No." := p_recGenJnlLine."Line No.";
          p_recJnlLineDim."Dimension Code" := l_recDefDim."Dimension Code";
          p_recJnlLineDim.VALIDATE("Dimension Value Code",l_recDefDim."Dimension Value Code");
          IF NOT p_recJnlLineDim.INSERT(TRUE) THEN
            //варианты перезаписи измерений в зависимости от типа учета значения
            CASE l_recDefDim."Value Posting" OF
              l_recDefDim."Value Posting"::"Code Mandatory": p_recJnlLineDim.MODIFY(TRUE);
              ELSE
                IF l_recJnlLineDim2.GET(p_recJnlLineDim."Table ID",
                  p_recJnlLineDim."Journal Template Name",p_recJnlLineDim."Journal Batch Name",
                    p_recJnlLineDim."Journal Line No.",p_recJnlLineDim."Allocation Line No.",p_recJnlLineDim."Dimension Code") THEN
                  IF l_recJnlLineDim2."Dimension Value Code"='' THEN
                    p_recJnlLineDim.MODIFY(TRUE)
                  ELSE
                    l_boolIsNeedModify := FALSE;
            END;
          }
          IF (l_recDefDim."Dimension Code" = g_recGLSetup."Global Dimension 1 Code") AND l_boolIsNeedModify THEN
            p_recGenJnlLine."Shortcut Dimension 1 Code":= l_recDefDim."Dimension Value Code";
          IF (l_recDefDim."Dimension Code" = g_recGLSetup."Global Dimension 2 Code") AND l_boolIsNeedModify THEN
            p_recGenJnlLine."Shortcut Dimension 2 Code" := l_recDefDim."Dimension Value Code";
        END;
      UNTIL l_recDefDim.NEXT = 0;
      //NC NOS-26 > SPA
      DimMgt.UpdateGenJnlLineDim(p_recGenJnlLine, DimMgt.GetDimensionSetID(TempDimSetEntry));
      p_recGenJnlLine.MODIFY;
      //NC NOS-26 < SPA
    END;

    PROCEDURE fn_CopyRecSetDimToJnlLineDim@1000000000(p_RecSet@1000000002 : DotNet "'System.Data, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Data.SqlClient.SqlDataReader";VAR p_recGenJnlLine@1210002 : Record 81);
    VAR
      l_recDefDim@1000000000 : Record 352;
      TempDimSetEntry@1101495000 : TEMPORARY Record 480;
      l_intn@1000000003 : Integer;
      l_codeDimVal@1000000001 : Code[20];
      l_codeacc@1000000004 : Code[20];
      l_codeDef_Dim@1000000006 : Code[20];
    BEGIN
      //NC NOS-26 > SPA
      IF p_recGenJnlLine."Dimension Set ID" <> 0 THEN
        DimMgt.GetDimensionSet(TempDimSetEntry, p_recGenJnlLine."Dimension Set ID");
      //NC NOS-26 < SPA

      l_recDefDim.RESET;
      l_recDefDim.SETRANGE("Table ID",DATABASE::"G/L Account");
      l_recDefDim.SETRANGE("No.",p_recGenJnlLine."Account No.");
      l_recDefDim.SETFILTER("Value Posting",'..%1',l_recDefDim."Value Posting"::"Same Code");
      l_codeacc := p_recGenJnlLine."Account No.";
      l_intn := 0;
      l_intn := l_recDefDim.COUNT;
      IF l_recDefDim.FIND('-') THEN
      REPEAT
        l_codeDef_Dim:=CONVERTSTR(l_recDefDim."Dimension Code",'.','_');
        //l_codeDimVal := g_cuAdoFunc.VarToText(p_RecSet.Fields().Item(l_codeDef_Dim).Value);
        l_codeDimVal := FORMAT(p_RecSet.Item(l_codeDef_Dim));
        IF l_codeDimVal <> '' THEN BEGIN
          //NC NOS-26 > SPA
          TempDimSetEntry.INIT;
          TempDimSetEntry.VALIDATE("Dimension Code", l_recDefDim."Dimension Code");
          IF TempDimSetEntry.FIND THEN
            TempDimSetEntry.DELETE;
          TempDimSetEntry.VALIDATE("Dimension Value Code", l_codeDimVal);
          TempDimSetEntry.SetObject(p_recGenJnlLine);
          TempDimSetEntry.INSERT(TRUE);
          //NC NOS-26 < SPA
          {
          p_recJnlLineDim.INIT;
          p_recJnlLineDim."Table ID" := DATABASE::"Gen. Journal Line";
          p_recJnlLineDim."Journal Template Name" := p_recGenJnlLine."Journal Template Name";
          p_recJnlLineDim."Journal Batch Name" := p_recGenJnlLine."Journal Batch Name";
          p_recJnlLineDim."Journal Line No." := p_recGenJnlLine."Line No.";
          p_recJnlLineDim."Dimension Code" := l_recDefDim."Dimension Code";
          p_recJnlLineDim.VALIDATE("Dimension Value Code",l_codeDimVal);
          IF NOT p_recJnlLineDim.INSERT(TRUE) THEN
            p_recJnlLineDim.MODIFY(TRUE);
          }
          IF l_recDefDim."Dimension Code" = g_recGLSetup."Global Dimension 1 Code" THEN
            p_recGenJnlLine."Shortcut Dimension 1 Code" := l_codeDimVal;
          IF l_recDefDim."Dimension Code" = g_recGLSetup."Global Dimension 2 Code" THEN
            p_recGenJnlLine."Shortcut Dimension 2 Code" := l_codeDimVal;

          //NC MIO-84.2 > DP
          IF l_recDefDim."Dimension Code"=g_recMovSetup."Customer Dimension Code" THEN BEGIN
            g_cuDimMgt.fn_GetLinkDim(
              TempDimSetEntry."Dimension Code",
              TempDimSetEntry."Dimension Value Code");

            g_cuDimMgt.fn_UpdateJnlLineLinkDim(
              TempDimSetEntry,
              p_recGenJnlLine."Journal Template Name",
              p_recGenJnlLine."Journal Batch Name")
          END;
          //NC MIO-84.2 < DP
          //NC MIO-91 > USE
          IF l_recDefDim."Dimension Code"=g_recConsSetup."IC Dimension Code" THEN
            g_ICcode:=l_codeDimVal;
          //NC MIO-91 < USE
        END;
      UNTIL l_recDefDim.NEXT = 0;
      //NC NOS-26 > SPA
      DimMgt.UpdateGenJnlLineDim(p_recGenJnlLine, DimMgt.GetDimensionSetID(TempDimSetEntry));
      p_recGenJnlLine.MODIFY;
      //NC NOS-26 < SPA
    END;

    PROCEDURE fn_GetSelectedDims@1210001();
    VAR
      Text50001@1210000 : TextConst 'RUS=Измерения';
    BEGIN
      IF g_txtColumnDim <> '' THEN
        g_recDimSelectionBuf1.CompareDimText(3,REPORT::"Adjust Local Currency CB",'',g_txtColumnDim,Text50001);
      g_recSelectedDim.GetSelectedDim(USERID,3,REPORT::"Adjust Local Currency CB",'',gt_recSelectedDim);
      gt_recSelectedDim.SETFILTER("New Dimension Value Code",'=%1','');
    END;

    PROCEDURE fn_GetNewSelectedDims@1210000();
    VAR
      Text50001@1210000 : TextConst 'RUS=Измерения';
    BEGIN
      IF g_txtColumnDim <> '' THEN
        g_recDimSelectionBuf1.CompareDimText(3,REPORT::"Adjust Local Currency CB",'',g_txtColumnDim,Text50001);
      g_recSelectedDim.GetSelectedDim(USERID,3,REPORT::"Adjust Local Currency CB",'',gt_recSelectedDimNew);
      gt_recSelectedDimNew.SETFILTER("New Dimension Value Code",'<>%1','');
    END;

    PROCEDURE fn_SetParameter@1000000001(p_dateNew@1000000000 : Date;p_NewJobProcLineNo@1101495000 : Integer);
    BEGIN
      g_dateIndex := p_dateNew;
      //NC MIO-35 > DP
      g_JobProcLineNo := p_NewJobProcLineNo;
      //NC MIO-35 < DP
    END;

    EVENT SqlConnection@1101495043::InfoMessage@51(sender@1101495001 : Variant;e@1101495000 : DotNet "'System.Data, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Data.SqlClient.SqlInfoMessageEventArgs");
    BEGIN
    END;

    EVENT SqlConnection@1101495043::StateChange@52(sender@1101495001 : Variant;e@1101495000 : DotNet "'System.Data, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Data.StateChangeEventArgs");
    BEGIN
    END;

    EVENT SqlConnection@1101495043::Disposed@53(sender@1101495001 : Variant;e@1101495000 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.EventArgs");
    BEGIN
    END;

    BEGIN
    {
      TDRA > Периодическое задание по переоценке валютных операций по курсу ЦБ
      NC RD RI001 NCS-612 - Добавлена передача признака ReportID
      TDRANCS-609
      TDRANCS-702 Связанные измерения не вставляются
      TDRANCS-1196 >
        Check order running Periodic Task, Добавлено разделение параметров отчета для SA и Cons заданий
        ADD global variable g_recJobPrStatus, g_recCompany
        MODIFY OnInitReport,OnPreReport
      NC MIO-35 DP Перенос функциональности IFRS
      NC MIO-46 DP Изменен триггер G/L Account - OnAfterGetRecord
      NC NCS-1553 DP Изменен триггер OnAfterGetRecord
      NC MIO-35.2 DP Включение в автоматизацию
         (изменены функция fn_SetParameter, тиггер Report - OnPostReport,  глоб. переменная g_JobProcLineNo)
      ----------------------------------------------------
      NC BLD01 Создан билд, включающий модицикации TDNCS-432,RI001,TDNCS-609,702,1196,MIO-35,MIO-46,NCS-1553,MIO-35.2
      NC MIO-35.3 Изменен триггер CopySelectedDimToJnlLineDim
      TDRANCS-1594   Modified G/L Account - OnAfterGetRecord()
      TDRANCS-1348> Clear Journal
      NC MIO-84.2 DP Изменена функция CopyRecSetDimToJnlLineDim
      NC MIO-85.2 DP Изменен триггер G/L Account - OnAfterGetRecord()
      NC MIO-88 USE Изменен триггер G/L Account - OnAfterGetRecord()
      NC MIO-91 USE Изменены триггеры G/L Account: OnPreDataItem(), OnAfterGetRecord() и функция fn_CopyRecSetDimToJnlLineDim
      NC MIO-94 USE Изменен триггер G/L Account - OnAfterGetRecord
      NC MIO-94.1 USE Изменен триггер G/L Account - OnAfterGetRecord
      NC MIO-94.2 USE Изменен триггер G/L Account - OnAfterGetRecord
      NC MIO-94.3 USE Изменен триггер G/L Account - OnAfterGetRecord
      BLD002 NCBLD01,MIO-35.3,NCS-1594,S1348,MIO-46,MIO-84.2,MIO-85.2,MIO-88,MIO-91
      NC NCS-2493 DP Modified trigger G/L Account - OnAfterGetRecord
      NC NCS-2526 DP Modified trigger G/L Account - OnAfterGetRecord
      --------------------------------------------------
      NC NOS-26 SPA Перенос кода на новую функциональность
    }
    END.
  }
  RDLDATA
  {
  }
}

